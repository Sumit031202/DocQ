# DocQ Phase 0 Design Document

## 1. File/Folder Layout

```
DocQ/
├── index.html              # Entry point
├── package.json            # Dependencies
├── vite.config.js          # Vite configuration
├── .env.local              # Local environment variables (Supabase keys)
├── src/
│   ├── main.jsx            # React root
│   ├── App.jsx             # Main app component (Routing/Tabs)
│   ├── lib/
│   │   └── supabase.js     # Supabase client initialization
│   ├── components/
│   │   ├── common/
│   │   │   ├── Toast.jsx
│   │   │   ├── Modal.jsx
│   │   │   └── Layout.jsx
│   │   ├── patient/
│   │   │   ├── PatientForm.jsx
│   │   │   └── TokenCard.jsx
│   │   └── admin/
│   │       ├── AdminLogin.jsx
│   │       ├── QueueList.jsx
│   │       ├── QueueItem.jsx
│   │       └── StatsPanel.jsx
│   └── styles/
│       └── index.css       # Global styles (Tailwind or CSS)
└── supabase/
    ├── schema.sql          # Database schema definitions
    └── functions.sql       # RPC functions
```

## 2. Database Schema (SQL)

```sql
-- Enable Row Level Security
ALTER TABLE IF EXISTS public.queue ENABLE ROW LEVEL SECURITY;

-- 1. Queue Table
CREATE TABLE public.queue (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  token_date date NOT NULL DEFAULT current_date,
  token_number integer NOT NULL,
  full_token text NOT NULL, -- e.g., "20251120-012"
  name text NOT NULL,
  phone text,
  email text,
  reason text,
  status text NOT NULL DEFAULT 'waiting', -- waiting | called | done | skipped | cancelled
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  estimated_wait_seconds integer,
  served_at timestamptz
);

-- Indexes
CREATE UNIQUE INDEX idx_queue_token_date_number ON public.queue (token_date, token_number);
CREATE INDEX idx_queue_status ON public.queue (status);

-- 2. Service Metrics Table
CREATE TABLE public.service_metrics (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  served_at timestamptz NOT NULL,
  service_duration_seconds integer NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);
```

## 3. Atomic Token Generation (RPC)

```sql
CREATE OR REPLACE FUNCTION public.insert_queue_item(
  p_name text,
  p_phone text,
  p_email text,
  p_reason text
) RETURNS public.queue AS $$
DECLARE
  new_token integer;
  new_full text;
  inserted_row public.queue%ROWTYPE;
  avg_service_time integer;
  people_ahead integer;
BEGIN
  -- Advisory lock to prevent race conditions on token generation
  PERFORM pg_advisory_xact_lock(hashtext('queue_daily_token_' || current_date::text));

  -- Calculate next token number
  SELECT COALESCE(MAX(token_number), 0) + 1 INTO new_token
    FROM public.queue WHERE token_date = current_date;

  -- Format full token string
  new_full := to_char(current_date, 'YYYYMMDD') || '-' || lpad(new_token::text, 3, '0');

  -- Calculate estimated wait time
  -- 1. Get average service time (last 20 records), default 10 mins (600s)
  SELECT COALESCE(AVG(service_duration_seconds)::integer, 600) INTO avg_service_time
  FROM (
    SELECT service_duration_seconds FROM public.service_metrics
    ORDER BY created_at DESC LIMIT 20
  ) sub;

  -- 2. Count people ahead (waiting status)
  SELECT COUNT(*) INTO people_ahead
  FROM public.queue
  WHERE token_date = current_date AND status = 'waiting';

  -- Insert new row
  INSERT INTO public.queue (
    token_date, token_number, full_token, name, phone, email, reason, status, estimated_wait_seconds
  )
  VALUES (
    current_date, new_token, new_full, p_name, p_phone, p_email, p_reason, 'waiting', 
    (avg_service_time * people_ahead)
  )
  RETURNING * INTO inserted_row;

  RETURN inserted_row;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 4. API Call Examples (JavaScript)

```javascript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_ANON_KEY');

// 1. Insert Queue Item (Patient Join)
async function joinQueue(name, phone, email, reason) {
  const { data, error } = await supabase
    .rpc('insert_queue_item', {
      p_name: name,
      p_phone: phone,
      p_email: email,
      p_reason: reason
    });
  
  if (error) console.error('Error joining queue:', error);
  else console.log('Joined queue:', data);
}

// 2. Fetch Queue (Admin View)
async function fetchQueue() {
  const { data, error } = await supabase
    .from('queue')
    .select('*')
    .eq('token_date', new Date().toISOString().split('T')[0])
    .order('token_number', { ascending: true });
    
  if (error) console.error('Error fetching queue:', error);
  else console.log('Queue:', data);
}

// 3. Update Status (Admin Action)
async function updateStatus(id, status) {
  const updates = { status, updated_at: new Date() };
  if (status === 'done') {
      updates.served_at = new Date();
      // Note: Service metrics insertion would typically be handled here or via trigger
  }

  const { data, error } = await supabase
    .from('queue')
    .update(updates)
    .eq('id', id);

  if (error) console.error('Error updating status:', error);
}
```

## 5. Frontend Routes/Components

### Routes (Single Page App with Tabs)
- `/` - Main Entry
  - Tab 1: **Patient View** (Default)
  - Tab 2: **Doctor/Admin View**

### Components
1.  **PatientPage**
    -   `PatientForm`: Inputs for Name, Phone, Reason.
    -   `TokenCard`: Displays assigned token, ETA, and position.
    -   `StatusTracker`: Subscribes to realtime updates for the specific token.
2.  **AdminPage** (Protected)
    -   `LoginForm`: Email/Password auth.
    -   `Dashboard`: Wrapper for queue list and stats.
    -   `QueueList`: Table/List of patients.
    -   `QueueItem`: Individual row with actions (Call, Done, Skip).
    -   `AddPatientModal`: Form for staff to add patient manually.
3.  **Shared**
    -   `Tabs`: Navigation between Patient/Admin.
    -   `RealtimeListener`: HOC or hook to manage Supabase subscriptions.

## 6. Pseudocode: Wait Time & Token Assignment

### Token Assignment (Atomic)
```
FUNCTION assign_token(patient_details):
  LOCK mutex_for_date(current_date)
  
  current_max = SELECT MAX(token_number) FROM queue WHERE date = current_date
  next_token = current_max + 1
  
  full_token_string = FORMAT(current_date, next_token)
  
  wait_time = CALCULATE_WAIT_TIME()
  
  INSERT INTO queue (..., token_number, full_token, estimated_wait)
  RETURN new_row
```

### Estimated Wait Time
```
FUNCTION CALCULATE_WAIT_TIME():
  avg_time = SELECT AVG(duration) FROM service_metrics ORDER BY time DESC LIMIT 20
  IF avg_time IS NULL:
    avg_time = 10 minutes
    
  queue_length = SELECT COUNT(*) FROM queue WHERE status = 'waiting'
  
  RETURN avg_time * queue_length
```

## 7. End-to-End Acceptance Tests

### Manual Test Cases
1.  **Patient Join**:
    -   Open Patient Tab.
    -   Enter Name "John Doe", Phone "555-0101".
    -   Click Join.
    -   **Verify**: Token card appears with a number (e.g., 1). ETA shows ~0 mins (if first).
2.  **Admin View**:
    -   Open Admin Tab in separate window/browser.
    -   Login.
    -   **Verify**: "John Doe" appears in the "Waiting" list.
3.  **Realtime Update**:
    -   On Admin Tab, click "Call" for "John Doe".
    -   **Verify**: Patient Tab (in other window) updates status to "Called".
4.  **Completion**:
    -   On Admin Tab, click "Done".
    -   **Verify**: Patient moves to "Done" list/history.
5.  **Second Patient**:
    -   Join as "Jane Doe".
    -   **Verify**: Token number is 2. ETA is calculated based on default or previous metrics.

### Automated Tests (Playwright)
-   **Test 1**: Patient Flow
    -   Go to `/`.
    -   Fill form selectors `#name`, `#phone`.
    -   Click `#join-btn`.
    -   Assert `#token-display` is visible.
-   **Test 2**: Admin Flow
    -   Go to `/`. Click Admin Tab.
    -   Fill login.
    -   Assert `.queue-list` contains patient name.
    -   Click `.btn-call`.
    -   Assert status badge changes to "Called".
